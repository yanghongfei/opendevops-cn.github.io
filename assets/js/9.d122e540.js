(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{257:function(s,t,a){"use strict";a.r(t);var n=a(28),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"单机部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单机部署"}},[s._v("#")]),s._v(" 单机部署")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("p",[s._v("完全抽象出来的本地部署方式，不理解Docker的同学可以使用本文的进行参考，线上我建议你分布式部署，分布式部署是Docker、Docker、Docker！！！")])]),s._v(" "),a("h2",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式,采用pm2进行守护，这是针对一些不想玩Docker的同学准备的，如果你想容器你就分布式部署aaaaa!!!!!\n另外这里没写域名管理是怎么部署的， 如果需要参考分部署部署！！！！")])]),s._v(" "),a("p",[a("strong",[s._v("建议配置")])]),s._v(" "),a("ul",[a("li",[s._v("系统：  CentOS7+")]),s._v(" "),a("li",[s._v("CPU：   4Core+")]),s._v(" "),a("li",[s._v("内存：  8G+")]),s._v(" "),a("li",[s._v("磁盘：  50G+")])]),s._v(" "),a("p",[a("strong",[s._v("基础环境")])]),s._v(" "),a("ul",[a("li",[s._v("版本约束\n"),a("ul",[a("li",[s._v("Python3.6")]),s._v(" "),a("li",[s._v("Redis3.2")]),s._v(" "),a("li",[s._v("MySQl5.7")]),s._v(" "),a("li",[s._v("RabbitMQ")]),s._v(" "),a("li",[s._v("node.js")])])])]),s._v(" "),a("p",[a("strong",[s._v("优化系统")])]),s._v(" "),a("p",[s._v("注意：")]),s._v(" "),a("ul",[a("li",[s._v("如果你的系统是新的，我们建议你先优化下系统，同样我们也提供了"),a("a",{attrs:{href:"https://github.com/opendevops-cn/opendevops/tree/master/scripts/system_init_v1.sh",target:"_blank",rel:"noopener noreferrer"}},[s._v("优化系统脚本"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("以下基础环境中，若你的系统中已经存在可跳过，直接配置，建议使用我们推荐的版本")])]),s._v(" "),a("p",[a("code",[s._v("Tips: 内部域名不要修改，不要修改，不要修改，都是内部通信！！！！！！！！！ 不会真的有人不听劝？？？？ ？？？？")])]),s._v(" "),a("p",[a("strong",[s._v("环境变量")])]),s._v(" "),a("blockquote",[a("p",[s._v("创建项目目录")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("$ mkdir -p /opt/codo/ && cd /opt/codo/\n")])])]),a("blockquote",[a("p",[s._v("以下内容贴入到"),a("code",[s._v("vim /opt/codo/env.sh")]),s._v("文件，主要修改配置地址和密码信息")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[31m 注意：token_secret一定要做修改，防止网站被攻击!!!!!!! "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m 注意：token_secret一定要做修改，防止网站被攻击!!!!!!! "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[33m 注意：token_secret一定要做修改，防止网站被攻击!!!!!!! "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n\n\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#部署的IP地址")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LOCALHOST_IP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.10.10.12"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置你的MYSQL密码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MYSQL_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"m9uSFL7duAVXfeAwGUSG"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### 设置你的redis密码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REDIS_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cWCVKJ7ZHUK12mVbivUf"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### RabbitMQ用户密码信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MQ_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ss"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MQ_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5Q2ajBHRT2lFJjnvaU0g"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#codo-admin用到的cookie和token")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cookie_secret")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nJ2oZis0V/xlArY2rzpIE6ioC9/KlqR2fd59sD=UXZJ=3OeROB"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里codo-admin和gw网关都会用到，一定要修改。可生成随意字符")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("token_secret")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pXFb4i%*834gfdh963df718iodGq4dsafsdadg7yI6ImF1999aaG7"')]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##如果要进行读写分离，Master-slave主从请自行建立，一般情况下都是只用一个数据库就可以了")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 写数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBHOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.10.10.12"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBPORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBUSER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBPWD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#export DEFAULT_DB_DBNAME=${mysql_database}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 读数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("READONLY_DB_DBHOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.10.10.12'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("READONLY_DB_DBPORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3306'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("READONLY_DB_DBUSER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("READONLY_DB_DBPWD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#export READONLY_DB_DBNAME=${mysql_database}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 消息队列")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_MQ_ADDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.10.10.12'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_MQ_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_USER}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_MQ_PWD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_PASSWORD}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 缓存")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_REDIS_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.10.10.12'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_REDIS_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_REDIS_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${REDIS_PASSWORD}")]),s._v("\n\n")])])]),a("p",[s._v("=="),a("strong",[s._v("最后一定不要忘记source")]),s._v("：==  "),a("code",[s._v("source /opt/codo/env.sh")])]),s._v(" "),a("p",[a("strong",[s._v("关闭SELINUX")])]),s._v(" "),a("ul",[a("li",[s._v("若已关闭请跳过")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#临时关闭")]),s._v("\n$ setenforce "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#或修改配置文件关闭,需要重启")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/selinux/config  \n\n将SELINUX"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("enforcing改为SELINUX"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("disabled \n设置后需要重启才能生效  \n\n")])])]),a("p",[a("strong",[s._v("清空防火墙规则")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只清空filter链即可")]),s._v("\n$ iptables -F\n\n")])])]),a("p",[a("strong",[s._v("安装Python3")])]),s._v(" "),a("blockquote",[a("p",[s._v("建议使用Python36,若你的系统里面已经存在Python36可以跳过此步骤。")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: Start install python3 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\nyum update -y\nyum groupinstall Development tools -y\nyum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" zlib-devel\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y openssl-devel libxslt-devel libxml2-devel libcurl-devel\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" python3 -y \n")])])]),a("p",[a("strong",[s._v("安装MySQL")])]),s._v(" "),a("blockquote",[a("p",[s._v("一般来说一个MySQL实例即可，如果有需求可以自行搭建主从，微服务每个服务都可以有自己的数据库")])]),s._v(" "),a("ul",[a("li",[s._v("必须使用MySQL 5.7,我这个安装下来应该是mysql5.6\n所以需要你改一下安装好的mysql配置文件")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#变量文件")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" http://repo.mysql.com/mysql-community-release-el6-5.noarch.rpm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh mysql-community-release-el6-5.noarch.rpm\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/yum.repos.d/mysql-community.repo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[mysql-connectors-community]\nname=MySQL Connectors Community\nbaseurl=http://repo.mysql.com/yum/mysql-connectors-community/el/6/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\nenabled=1\ngpgcheck=1\ngpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql\n\n[mysql-tools-community]\nname=MySQL Tools Community\nbaseurl=http://repo.mysql.com/yum/mysql-tools-community/el/6/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\nenabled=1\ngpgcheck=1\ngpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql\n\n# Enable to use MySQL 5.5\n[mysql55-community]\nname=MySQL 5.5 Community Server\nbaseurl=http://repo.mysql.com/yum/mysql-5.5-community/el/6/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\nenabled=0\ngpgcheck=1\ngpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql\n\n# Enable to use MySQL 5.6\n[mysql56-community]\nname=MySQL 5.6 Community Server\nbaseurl=http://repo.mysql.com/yum/mysql-5.6-community/el/6/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\nenabled=0\ngpgcheck=1\ngpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql\n\n# Note: MySQL 5.7 is currently in development. For use at your own risk.\n# Please read with sub pages: https://dev.mysql.com/doc/relnotes/mysql/5.7/en/\n[mysql57-community-dmr]\nname=MySQL 5.7 Community Server Development Milestone Release\nbaseurl=http://repo.mysql.com/yum/mysql-5.7-community/el/7/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$basearch")]),s._v("/\nenabled=1\ngpgcheck=1\ngpgkey=file:/etc/pki/rpm-gpg/RPM-GPG-KEY-mysql\nEOF")]),s._v("\n\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql-community-server -y\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chkconfig")]),s._v(" mysqld on\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" mysqld start\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"info: start mysql grant user."')]),s._v("\nmysql -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CREATE USER '),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("codo"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("@"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("localhost"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("  IDENTIFIED BY  "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(";CREATE USER "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("codo"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("@"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("%"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("  IDENTIFIED BY  "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('"')]),s._v(" \nmysql -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" GRANT ALL PRIVILEGES ON *.* TO '),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("codo"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("@"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("localhost"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" IDENTIFIED BY "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(";GRANT ALL PRIVILEGES ON *.* TO "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("codo"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("@"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("%"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" IDENTIFIED BY "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(";GRANT ALL PRIVILEGES ON *.* TO "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("codo"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("@"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("HOSTNAME")]),s._v("}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" IDENTIFIED BY  "),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('; "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])])]),a("ul",[a("li",[s._v("测试 "),a("code",[s._v("mysql -h127.0.0.1 -ucodo -p${MYSQL_PASSWORD}")])])]),s._v(" "),a("p",[a("strong",[s._v("安装Redis")])]),s._v(" "),a("ul",[a("li",[s._v("若有请跳过")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis -y\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"requirepass '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${REDIS_PASSWORD}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/^daemonize.*$/daemonize yes/g"')]),s._v(" /etc/redis.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#bind 127.0.0.1 如果是开启的请关闭掉")]),s._v("\nsystemctl start redis\nsystemctl status redis\n")])])]),a("ul",[a("li",[s._v("测试 "),a("code",[s._v("redis-cli -h 127.0.0.1 -p 6379 -a ${REDIS_PASSWORD}")])])]),s._v(" "),a("p",[a("strong",[s._v("安装RabbitMQ")])]),s._v(" "),a("ul",[a("li",[s._v("创建 docker-compose.yml")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: Start install rabbitmq "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo $LOCALHOST_IP opendevops >> /etc/hosts")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo opendevops > /etc/hostname")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# export HOSTNAME=opendevops")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("  -y rabbitmq-server\nrabbitmq-plugins "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" rabbitmq_management\nsystemctl start rabbitmq-server\nrabbitmqctl add_user "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_USER}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_PASSWORD}")]),s._v("\nrabbitmqctl set_user_tags "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_USER}")]),s._v(" administrator\nrabbitmqctl  set_permissions  -p  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MQ_USER}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),s._v("\nsystemctl restart rabbitmq-server\nsystemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" rabbitmq-server\nsystemctl status rabbitmq-server\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rabbitmq-server -detached")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("systemctl status rabbitmq-server "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"running"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$status")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: rabbitmq install success. "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[31m [ERROR]: rabbitmq install faild "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" -5\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),a("p",[a("strong",[s._v("安装DNS")])]),s._v(" "),a("ul",[a("li",[s._v("注意，这里如果你内部有自己DNS，你也可以选择使用你自己的, 若没有请继续安装")])]),s._v(" "),a("blockquote",[a("p",[s._v("部署内部DNS dnsmasq 用于服务间内部通信，API网关需要配置，切记")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: Start install dnsmasq "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" dnsmasq -y\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置上游DNS，毕竟你的Dns只是个代理")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/resolv.dnsmasq "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nnameserver 114.114.114.114\nnameserver 8.8.8.8\nEOF")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置host解析")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: 如果你是单机部署，那么你就将你的本机IP+模块域名解析即可，如果你是分布式部署的，那么每个模块对应的机器IP一定不要搞错，这个很重要，后面网关也要依赖此DNS去解析你的域名，帮你做服务转发的，切记！！！！\n "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/etc/dnsmasqhosts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" demo-init.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" mg.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" task.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" gw.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" cmdb2.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" kerrigan.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" tools.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" cron.opendevops.cn\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$LOCALHOST_IP")]),s._v(" dns.opendevops.cn\nEOF")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/dnsmasqhosts "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#检查下")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加配置")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意下一步是覆盖你本机的DNS，建议把你的DNS地址加在/etc/resolv.dnsmasq 里面 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -rp /etc/resolv.conf /etc/resolv.conf-"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" +%F"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "nameserver $LOCALHOST_IP" > /etc/resolv.conf  ')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1i'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("ameserver "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOCALHOST_IP}")]),s._v('"')]),s._v(" /etc/resolv.conf -i \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("###注意注意， 这里修改完后，请你一定要确定你nameserver ${LOCALHOST_IP} 内部DNS在第一条、第一条、第一条，放在下面是不能正常解析的.")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resolv-file=/etc/resolv.dnsmasq"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/dnsmasq.conf\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"addn-hosts=/etc/dnsmasqhosts"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/dnsmasq.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 启动")]),s._v("\n/bin/systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" dnsmasq.service\n/bin/systemctl start dnsmasq.service\nsystemctl status dnsmasq\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$?")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: dnsmasq install success. "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[31m [ERROR]: dnsmasq install faild "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" -6\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),a("p",[a("strong",[s._v("安装node环境")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Q: 小伙伴们一定质疑我为什么python使用pm2进行守护,这玩意不是用node的嘛？")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#A: supervisor用时间长了，就想尝试下pm2, emmmmmm.....")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -f /usr/local/bin/node "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Node already exists"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v(" -1\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/src "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf node-v8.11.3-linux-x64.tar.xz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" -q -c https://nodejs.org/dist/v8.11.3/node-v8.11.3-linux-x64.tar.xz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xf node-v8.11.3-linux-x64.tar.xz -C  /usr/local/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /usr/local/bin/node\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -rf /usr/local/bin/npm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/node-v8.11.3-linux-x64/bin/node /usr/local/bin/node\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/node-v8.11.3-linux-x64/bin/node /usr/bin/node\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/node-v8.11.3-linux-x64/bin/npm  /usr/local/bin/npm\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/node-v8.11.3-linux-x64/bin/npm  /usr/bin/npm\n/usr/local/bin/node -v\n/usr/local/bin/npm -v\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" i -g pm2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ln")]),s._v(" -s /usr/local/node-v8.11.3-linux-x64/bin/pm2 /usr/bin/\n\n")])])]),a("p",[a("strong",[s._v("安装websdk")])]),s._v(" "),a("ul",[a("li",[s._v("websdk是自己实现的一套运维平台开发工具包，集成了很多方法在里面，此步骤是必要的")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#前提环境是有python3 + pip3")]),s._v("\npip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -U git+https://github.com/ss1917/ops_sdk.git\n")])])]),a("p",[a("strong",[s._v("以上，基础依赖部署完毕")])]),s._v(" "),a("h2",{attrs:{id:"管理后端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理后端"}},[s._v("#")]),s._v(" 管理后端")]),s._v(" "),a("p",[a("code",[s._v("codo-admin")]),s._v("是基于tornado框架 restful风格的API 实现后台管理,"),a("a",{attrs:{href:"https://github.com/opendevops-cn/codo-admin",target:"_blank",rel:"noopener noreferrer"}},[s._v("codo详细参考"),a("OutboundLink")],1),s._v(",搭配使用"),a("code",[s._v("codo")]),s._v("前端(iView+ vue)组成的一套后台用户 权限以及系统管理的解决方案（提供登录，注册 密码修改 鉴权 用户管理 角色管理 权限管理 前端组件管理 前端路由管理 通知服务API 系统基础信息接口）")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo-admin.git "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo-admin  \n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("blockquote",[a("p",[s._v("注意：这里的"),a("code",[s._v("cookie_secret")]),s._v("和"),a("code",[s._v("token_secret")]),s._v("必须和你的env.sh里面的保持一致，后续网关也要用到这个。若不保持一直登陆后校验不通过回被自动踢回，会导致页面一直不停的刷新")])]),s._v(" "),a("p",[a("code",[s._v("注意：这里的token_secret必须要和你的网关保持一致，这个值是从env.sh拿来的，一定要做修改，防止网站被攻击，如果secret包含正则符号会导致sed失败，请仔细检查")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py  \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#token_secret = .*#token_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${token_secret}")]),s._v("'#g\"")]),s._v(" settings.py     \n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##我们项目支持取env环境变量，但是还是建议修改下。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_admin'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只读MySQL配置，若是单台也直接写成Master地址即可")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBHOST = .*#READONLY_DB_DBHOST = os.getenv('READONLY_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPORT = .*#READONLY_DB_DBPORT = os.getenv('READONLY_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBUSER = .*#READONLY_DB_DBUSER = os.getenv('READONLY_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPWD = .*#READONLY_DB_DBPWD = os.getenv('READONLY_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBNAME = .*#READONLY_DB_DBNAME = os.getenv('READONLY_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#redis配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_HOST = .*#DEFAULT_REDIS_HOST = os.getenv('DEFAULT_REDIS_HOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_HOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PORT = .*#DEFAULT_REDIS_PORT = os.getenv('DEFAULT_REDIS_PORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PASSWORD = .*#DEFAULT_REDIS_PASSWORD = os.getenv('DEFAULT_REDIS_PASSWORD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PASSWORD}")]),s._v("')#g\"")]),s._v(" settings.py\n\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo/codo-admin/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [{\n    "name": "codo-admin-9800",\n    "script": "python3 startup.py --service=mg --port=9800",\n    "cwd": "/opt/codo/codo-admin/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/admin.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-admin-9801",\n    "script": "python3 startup.py --service=mg --port=9801",\n    "cwd": "/opt/codo/codo-admin/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/admin.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-admin-9802",\n    "script": "python3 startup.py --service=mg --port=9802" ,\n    "cwd": "/opt/codo/codo-admin/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/admin.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-admin-sub_log",\n    "script": "python3 startup.py --service=sub_log --port=9803" ,\n    "cwd": "/opt/codo/codo-admin/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/admin_sub_log.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n\n]}\nEOF')]),s._v("\n\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_admin default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("导入数据")])]),s._v(" "),a("p",[s._v("主要是菜单，组件，权限列表，内置的用户等")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#导入数据\nmysql -h127.0.0.1 -u${DEFAULT_DB_DBUSER} -p${MYSQL_PASSWORD} codo_admin < ./doc/codo_admin_beta0.3.sql\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\n")])])]),a("p",[a("strong",[s._v("测试codo-admin")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/admin.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-admin 部署完毕")])]),s._v(" "),a("h2",{attrs:{id:"资产管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#资产管理"}},[s._v("#")]),s._v(" 资产管理")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: codo_cmdb(资产管理) Start install. "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo-cmdb.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo-cmdb\n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#修改配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后端数据库名称,建议不要修改，初始化data.sql已经指定了数据库名字，若需改请一块修改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CMDB_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_cmdb'")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#任务系统的域名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CMDB_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只读MySQL配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBHOST = .*#READONLY_DB_DBHOST = os.getenv('READONLY_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPORT = .*#READONLY_DB_DBPORT = os.getenv('READONLY_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBUSER = .*#READONLY_DB_DBUSER = os.getenv('READONLY_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPWD = .*#READONLY_DB_DBPWD = os.getenv('READONLY_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBNAME = .*#READONLY_DB_DBNAME = os.getenv('READONLY_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CMDB_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#redis配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_HOST = .*#DEFAULT_REDIS_HOST = os.getenv('DEFAULT_REDIS_HOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_HOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PORT = .*#DEFAULT_REDIS_PORT = os.getenv('DEFAULT_REDIS_PORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PASSWORD = .*#DEFAULT_REDIS_PASSWORD = os.getenv('DEFAULT_REDIS_PASSWORD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PASSWORD}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这里如果配置codo-task的数据库地址，则将数据同步到作业配置")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TASK_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_task'")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#CODO_TASK_DB_HOST = .*#CODO_TASK_DB_HOST = os.getenv('CODO_TASK_DB_HOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#CODO_TASK_DB_PORT = .*#CODO_TASK_DB_PORT = os.getenv('CODO_TASK_DB_PORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#CODO_TASK_DB_USER = .*#CODO_TASK_DB_USER = os.getenv('CODO_TASK_DB_USER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#CODO_TASK_DB_PWD = .*#CODO_TASK_DB_PWD = os.getenv('CODO_TASK_DB_PWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#CODO_TASK_DB_DBNAME = .*#CODO_TASK_DB_DBNAME = os.getenv('CODO_TASK_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TASK_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#AWS事件和WebTerminnal配置")]),s._v("\ndocker pull webterminal/webterminallte\ndocker run -itd -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 webterminal/webterminallte\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Aws Events 事件邮件通知人")]),s._v("\nAWS_EVENT_TO_EMAIL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1111@qq.com,2222@gmail.com'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#Web Terminal 地址，请填写你部署的webterminal地址")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#注意这里是填写你上面docker run的机器外网IP")]),s._v("\nWEB_TERMINAL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://1.1.1.1:8080'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [{\n    "name": "codo-cmdb-9000",\n    "script": "python3 startup.py --service=cmdb --port=9000",\n    "cwd": "/opt/codo/codo-cmdb/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/cmdb.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-cmdb-9001",\n    "script": "python3 startup.py --service=cmdb --port=9001",\n    "cwd": "/opt/codo/codo-cmdb/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/cmdb.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n  {\n    "name": "codo-cmdb-9002",\n    "script": "python3 startup.py --service=cmdb --port=9002",\n    "cwd": "/opt/codo/codo-cmdb/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/cmdb.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n  {\n    "name": "codo-cmdb-cron",\n    "script": "python3 startup.py --service=cmdb_cron",\n    "cwd": "/opt/codo/codo-cmdb/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/cmdb_cron.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n\n]}\nEOF')]),s._v("\n\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_cmdb default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\n")])])]),a("p",[a("strong",[s._v("测试codo-cmdb")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/cmdb.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-cmdb 部署完毕")])]),s._v(" "),a("h2",{attrs:{id:"任务系统"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务系统"}},[s._v("#")]),s._v(" 任务系统")]),s._v(" "),a("p",[s._v("CODO任务系统，负责整个系统中任务调度，此功能是必须要安装的")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: codo-task(任务系统) Start install. "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo-task.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo-task\n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#修改配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TASK_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_task'")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#任务系统的域名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TASK_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只读MySQL配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBHOST = .*#READONLY_DB_DBHOST = os.getenv('READONLY_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPORT = .*#READONLY_DB_DBPORT = os.getenv('READONLY_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBUSER = .*#READONLY_DB_DBUSER = os.getenv('READONLY_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPWD = .*#READONLY_DB_DBPWD = os.getenv('READONLY_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBNAME = .*#READONLY_DB_DBNAME = os.getenv('READONLY_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TASK_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#redis配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_HOST = .*#DEFAULT_REDIS_HOST = os.getenv('DEFAULT_REDIS_HOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_HOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PORT = .*#DEFAULT_REDIS_PORT = os.getenv('DEFAULT_REDIS_PORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PASSWORD = .*#DEFAULT_REDIS_PASSWORD = os.getenv('DEFAULT_REDIS_PASSWORD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PASSWORD}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#MQ配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_MQ_ADDR = .*#DEFAULT_MQ_ADDR = os.getenv('DEFAULT_MQ_ADDR', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_MQ_ADDR}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_MQ_USER = .*#DEFAULT_MQ_USER = os.getenv('DEFAULT_MQ_USER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_MQ_USER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_MQ_PWD = .*#DEFAULT_MQ_PWD = os.getenv('DEFAULT_MQ_PWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_MQ_PWD}")]),s._v("')#g\"")]),s._v(" settings.py\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护，任务系统分别有执行任务和任务主服务程序，这里是单独分开的")])]),s._v(" "),a("ul",[a("li",[s._v("注意：执行任务可使用"),a("code",[s._v("pm2 scale codo-task-exec_task +1")]),s._v("进行横向扩展，开启的进程越多，则支持的并发任务则越多")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#主服务程序")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [\n    {\n      "name": "codo-task-api-8900",\n      "script": "python3 startup.py --service=task_api --port=8900",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-api-8901",\n      "script": "python3 startup.py --service=task_api --port=8901",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-api-8902",\n      "script": "python3 startup.py --service=task_api --port=8902",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-api-8903",\n      "script": "python3 startup.py --service=task_api --port=8903",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-other-9600",\n      "script": "python3 startup.py --service=other --port=9600",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task_other.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-other-9601",\n      "script": "python3 startup.py --service=other --port=9601",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task_other.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-log-record",\n      "script": "python3 startup.py --service=log_record --port=9608",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task_log_record.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    },\n    {\n      "name": "codo-task-cron",\n      "script": "python3 startup.py --service=cron_app --port=9609",\n      "cwd": "/opt/codo/codo-task/",\n      "max_memory_restart": "150M",\n      "log_date_format": "YYYY-MM-DD HH:mm Z",\n      "log_file": "/var/log/supervisor/task_cron.log",\n      "autorestart": true,\n      "node_args": [],\n      "args": [],\n      "env": {\n      }\n    }\n  ]\n}\n\nEOF')]),s._v("\n\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#exec_task进程")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("exec_task.config.js"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nmodule.exports = {\n  apps : [{\n    name: 'codo-task-exec_task',\n    script: 'python3 startup.py --service=exec_task',\n    // Options reference: https://pm2.io/doc/en/runtime/reference/ecosystem-file/\n    args: '',\n    instances: 15, // 启动15个进程,进程数=任务数\n    autorestart: true,\n    watch: false,\n    max_memory_restart: '200M',\n    log_date_format  : \"YYYY-MM-DD HH:mm Z\",\n    log_file   : \"/var/log/supervisor/exec_task.log\",\n    env: {\n      NODE_ENV: 'development'\n    },\n    env_production: {\n      NODE_ENV: 'production'\n    }\n  }],\n};\n\nEOF")]),s._v("\n\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_task default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\npm2 start exec_task.config.js\n")])])]),a("p",[a("strong",[s._v("测试codo-task")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/task.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\ntailf /var/log/supervisor/exec_task.log\ntailf /var/log/supervisor/task_cron.log\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-task 部署完毕")])]),s._v(" "),a("h2",{attrs:{id:"定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定时任务"}},[s._v("#")]),s._v(" 定时任务")]),s._v(" "),a("p",[s._v("CODO项目定时任务模块，定时任务完全兼容crontab，支持到秒级")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v("[32m [INFO]: codo_cron(定时任务) Start install. "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\033"}},[s._v("\\033")]),s._v('[0m"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo-cron.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo-cron\n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#后端数据库名称,建议不要修改，初始化data.sql已经指定了数据库名字，若需改请一块修改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CRON_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_cron'")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CRON_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只读MySQL配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBHOST = .*#READONLY_DB_DBHOST = os.getenv('READONLY_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPORT = .*#READONLY_DB_DBPORT = os.getenv('READONLY_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBUSER = .*#READONLY_DB_DBUSER = os.getenv('READONLY_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPWD = .*#READONLY_DB_DBPWD = os.getenv('READONLY_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBNAME = .*#READONLY_DB_DBNAME = os.getenv('READONLY_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CRON_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [{\n    "name": "codo-cron-9900",\n    "script": "python3 startup.py --service=cron --port=9900",\n    "cwd": "/opt/codo/codo-cron/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/cron.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  }]\n}\nEOF')]),s._v("\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_cron default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\n")])])]),a("p",[a("strong",[s._v("测试")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/cron.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-cron部署完毕")])]),s._v(" "),a("h2",{attrs:{id:"配置中心"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置中心"}},[s._v("#")]),s._v(" 配置中心")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/kerrigan.git "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" kerrigan\n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#修改管理后端域名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##我们项目支持取env环境变量，但是还是建议修改下。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_kerrigan'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#只读MySQL配置，若是单台也直接写成Master地址即可")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBHOST = .*#READONLY_DB_DBHOST = os.getenv('READONLY_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPORT = .*#READONLY_DB_DBPORT = os.getenv('READONLY_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBUSER = .*#READONLY_DB_DBUSER = os.getenv('READONLY_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBPWD = .*#READONLY_DB_DBPWD = os.getenv('READONLY_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${READONLY_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#READONLY_DB_DBNAME = .*#READONLY_DB_DBNAME = os.getenv('READONLY_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [{\n    "name": "codo-kerrigan-9100",\n    "script": "python3 startup.py --service=kerrigan --port=9100",\n    "cwd": "/opt/codo/kerrigan/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/kerrigan.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-kerrigan-9101",\n    "script": "python3 startup.py --service=kerrigan --port=9101",\n    "cwd": "/opt/codo/kerrigan/",\n    "max_memory_restart": "500M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/kerrigan.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n]}\n\nEOF')]),s._v("\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_kerrigan default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\n")])])]),a("p",[a("strong",[s._v("测试")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/kerrigan.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-kerrigan部署完成")])]),s._v(" "),a("h2",{attrs:{id:"运维工具"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#运维工具"}},[s._v("#")]),s._v(" 运维工具")]),s._v(" "),a("p",[a("strong",[s._v("获取代码")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo-tools.git "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo-tools\n")])])]),a("p",[a("strong",[s._v("修改相关配置")])]),s._v(" "),a("p",[s._v("修改"),a("code",[s._v("settings.py")]),s._v("配置")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#导入环境变量文件，最开始准备的环境变量文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" /opt/codo/env.sh\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#cookie_secret = .*#cookie_secret = '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${cookie_secret}")]),s._v("'#g\"")]),s._v(" settings.py \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#mysql配置信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##我们项目支持取env环境变量，但是还是建议修改下。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEFAULT_DB_DBNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'codo_tools'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBHOST = .*#DEFAULT_DB_DBHOST = os.getenv('DEFAULT_DB_DBHOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBHOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPORT = .*#DEFAULT_DB_DBPORT = os.getenv('DEFAULT_DB_DBPORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBUSER = .*#DEFAULT_DB_DBUSER = os.getenv('DEFAULT_DB_DBUSER', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBPWD = .*#DEFAULT_DB_DBPWD = os.getenv('DEFAULT_DB_DBPWD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBPWD}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_DB_DBNAME = .*#DEFAULT_DB_DBNAME = os.getenv('DEFAULT_DB_DBNAME', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBNAME}")]),s._v("')#g\"")]),s._v(" settings.py\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#redis配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_HOST = .*#DEFAULT_REDIS_HOST = os.getenv('DEFAULT_REDIS_HOST', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_HOST}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PORT = .*#DEFAULT_REDIS_PORT = os.getenv('DEFAULT_REDIS_PORT', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PORT}")]),s._v("')#g\"")]),s._v(" settings.py\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -i "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"s#DEFAULT_REDIS_PASSWORD = .*#DEFAULT_REDIS_PASSWORD = os.getenv('DEFAULT_REDIS_PASSWORD', '"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_REDIS_PASSWORD}")]),s._v("')#g\"")]),s._v(" settings.py\n")])])]),a("p",[a("strong",[s._v("生成配置")])]),s._v(" "),a("blockquote",[a("p",[s._v("本地部署方式采用pm2守护")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("pm2.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "apps": [{\n    "name": "codo-tools-9200",\n    "script": "python3 startup.py --service=tools --port=9200",\n    "cwd": "/opt/codo/codo-tools/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/tools.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-tools-9201",\n    "script": "python3 startup.py --service=tools --port=9201",\n    "cwd": "/opt/codo/codo-tools/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/tools.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n{\n    "name": "codo-tools-cron",\n    "script": "python3 startup.py --service=tools --port=9202" ,\n    "cwd": "/opt/codo/codo-tools/",\n    "max_memory_restart": "150M",\n    "log_date_format"  : "YYYY-MM-DD HH:mm Z",\n    "log_file"   : "/var/log/supervisor/tools_cron.log",\n    "autorestart": true,\n    "node_args": [],\n    "args": [],\n    "env": {\n    }\n  },\n\n]}\nEOF')]),s._v("\n")])])]),a("p",[a("strong",[s._v("安装依赖")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pip3 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -r doc/requirements.txt\n")])])]),a("p",[a("strong",[s._v("创建数据库")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("mysql -h127.0.0.1 -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${DEFAULT_DB_DBUSER}")]),s._v(" -p"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYSQL_PASSWORD}")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'create database codo_tools default character set utf8mb4 collate utf8mb4_unicode_ci;'")]),s._v("\n")])])]),a("p",[a("strong",[s._v("初始化表结构")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("python3 db_sync.py\n")])])]),a("p",[a("strong",[s._v("启动")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pm2 start pm2.json\n")])])]),a("p",[a("strong",[s._v("测试")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#01.日志")]),s._v("\ntailf /var/log/supervisor/tools.log "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#确认没有报错")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#02. 状态")]),s._v("\npm2 list "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" pm2 logs\n")])])]),a("p",[a("strong",[s._v("codo-tools部署完成")])]),s._v(" "),a("h2",{attrs:{id:"api网关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api网关"}},[s._v("#")]),s._v(" API网关")]),s._v(" "),a("p",[s._v("API网关系统,是基于openresty + Lua开发的一套API网关系统")]),s._v(" "),a("p",[a("strong",[s._v("安装openresty")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yum部署")]),s._v("\nyum update  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果系统老建议update下")]),s._v("\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" yum-utils -y\nyum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" openresty -y\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" openresty-resty -y\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/ss1917/api-gateway.git\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("cp -arp api-gateway/* /usr/local/openresty/nginx/\n\n")])])]),a("p",[a("strong",[s._v("目录结构")])]),s._v(" "),a("ul",[a("li",[s._v("以下文件都是比较重要的，这个文件是手动自己创建的！")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/usr/local/openresty/nginx/\n├── conf\n│   ├── conf.d\n│   │   ├── admin.conf  //管理后台admin\n│   │   ├── cmdb.conf   //资产管理\n│   │   ├── demo.conf   //用户访问入口\n│   │   ├── gw.conf    // 网关配置文件\n│   │   ├── kerrigan.conf  //配置中心\n│   │   ├── task.conf     //任务系统\n│   │   └── tools.conf    //运维工具\n├── lua\n│   ├── configs.lua    //网关配置转发\n\n")])])]),a("p",[a("strong",[s._v("配置nginx")])]),s._v(" "),a("ul",[a("li",[s._v("这里主要修改resolver 内部DNS服务器地址")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("user root;\nworker_processes auto;\nworker_rlimit_nofile 51200;\nerror_log logs/error.log;\nevents {\n    use epoll;\n    worker_connections 51024;\n}\nhttp {\n    #设置默认lua搜索路径\n    lua_package_path '$prefix/lua/?.lua;/blah/?.lua;;';\n    lua_code_cache on;\t\t#线上环境设置为on, off时可以热加载lua文件\n    lua_shared_dict user_info 1m;\n    lua_shared_dict my_limit_conn_store 100m;   #100M可以放1.6M个键值对\n    include             mime.types;    #代理静态文件\n\n    client_header_buffer_size 64k;\n    large_client_header_buffers 4 64k;\n    \n    gzip on;\n    gzip_min_length 1k;\n    gzip_comp_level 2;\n    gzip_types text/plain application/x-javascript text/css application/xml text/javascript;\n    gzip_vary on;\n    gzip_buffers 4 16k;\n    gzip_http_version 1.1;\n\n    init_by_lua_file lua/init_by_lua.lua;       # nginx启动时就会执行\n    include ./conf.d/*.conf;                    # lua生成upstream\n    resolver 10.10.10.12 ipv6=off;                      # 内部DNS\n}\n\n")])])]),a("p",[a("strong",[s._v("配置vhosts")]),s._v("\n以下内容是上面提到的所有vhost域名配置，这里面的配置都是和之前部署服务启动的端口一一对应起来的，若要修改，请也记得修改此处")]),s._v(" "),a("p",[a("code",[s._v("PATH: /usr/local/openresty/nginx/conf/conf.d")])]),s._v(" "),a("p",[a("code",[s._v("admin.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream  codo-admin{\n    server  127.0.0.1:9800; \n    server  127.0.0.1:9801;\n    server  127.0.0.1:9802;\n}\n\n\nserver\n{\n        listen 80;\n        server_name  mg.opendevops.cn;\n        access_log /var/log/nginx/codo-admin_access.log;\n        error_log  /var/log/nginx/codo-admin_error.log;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_set_header  Cookie $http_cookie;\n                proxy_pass http://codo-admin;\n        }\n}\n\n")])])]),a("p",[a("code",[s._v("cmdb.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream  codo-cmdb{\n    server  127.0.0.1:9000;\n    server  127.0.0.1:9001;\n    server  127.0.0.1:9002;\n}\n\n\nserver\n{\n        listen 80;\n        server_name  cmdb2.opendevops.cn;\n        access_log /var/log/nginx/codo-cmdb_access.log;\n        error_log  /var/log/nginx/codo-cmdb_error.log;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_set_header  Cookie $http_cookie;\n                proxy_pass http://codo-cmdb;\n        }\n}\n")])])]),a("p",[a("code",[s._v("kerrigan.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream  codo-kerrigan{\n    server  127.0.0.1:9100;\n    server  127.0.0.1:9101;\n}\n\n\nserver\n{\n        listen 80;\n        server_name  kerrigan.opendevops.cn;\n        access_log /var/log/nginx/codo-kerrigan_access.log;\n        error_log  /var/log/nginx/codo-kerrigan_error.log;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_set_header  Cookie $http_cookie;\n                proxy_pass http://codo-kerrigan;\n        }\n}\n\n")])])]),a("p",[a("code",[s._v("task.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('upstream  codo-task{\n    server  127.0.0.1:8900;\n    server  127.0.0.1:8901;\n    server  127.0.0.1:8902;\n    server  127.0.0.1:8903;\n}\n\nupstream  task-other{\n    server  127.0.0.1:9600;\n    server  127.0.0.1:9601;\n    server  127.0.0.1:9602;\n}\n\nserver {\n        listen 80;\n        server_name task.opendevops.cn;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_pass http://codo-task;\n\n        }\n        location /ws/ {\n                ### ws 支持\n                proxy_http_version 1.1;\n                proxy_set_header Upgrade $http_upgrade;\n                proxy_set_header Connection "upgrade";\n\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_pass http://task-other;\n        }\n        location /other/ {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_pass http://task-other;\n        }\n}\n\n')])])]),a("p",[a("code",[s._v("tools.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream  codo-tools{\n    server  127.0.0.1:9200;\n    server  127.0.0.1:9201;\n}\n\n\nserver\n{\n        listen 80;\n        server_name  tools.opendevops.cn;\n        access_log /var/log/nginx/codo-tools_access.log;\n        error_log  /var/log/nginx/codo-tools_error.log;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_set_header  Cookie $http_cookie;\n                proxy_pass http://codo-tools;\n        }\n}\n")])])]),a("p",[a("code",[s._v("cron.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("upstream  codo-cron{\n    server  127.0.0.1:9900;\n}\n\n\nserver\n{\n        listen 80;\n        server_name  cron.opendevops.cn;\n        access_log /var/log/nginx/codo-cron_access.log;\n        error_log  /var/log/nginx/codo-cron_error.log;\n        location / {\n                proxy_set_header Host $http_host;\n                proxy_redirect off;\n                proxy_set_header X-Real-IP $remote_addr;\n                proxy_set_header X-Scheme $scheme;\n                proxy_set_header  Cookie $http_cookie;\n                proxy_pass http://codo-cron;\n        }\n}\n")])])]),a("p",[a("code",[s._v("gw.conf")])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('    server {\n        listen 80;\n        server_name gw.opendevops.cn;\n        lua_need_request_body on;           # 开启获取body数据记录日志\n\n        location / {\n            ### ws 支持\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection "upgrade";\n\n            ### 获取真实IP\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n            access_by_lua_file lua/access_check.lua;\n            set $my_upstream $my_upstream;\n            proxy_pass http://$my_upstream;\n\n            ### 跨域\n            add_header Access-Control-Allow-Methods *;\n            add_header Access-Control-Max-Age 3600;\n            add_header Access-Control-Allow-Credentials true;\n            add_header Access-Control-Allow-Origin $http_origin;\n            add_header Access-Control-Allow-Headers $http_access_control_request_headers;\n            if ($request_method = OPTIONS){\n                return 204;}\n        }\n    }\n\n')])])]),a("p",[a("code",[s._v("demo.conf")])]),s._v(" "),a("ul",[a("li",[s._v("前端访问入口,里面内容不需要更改，后面会将网站静态文件放到"),a("code",[s._v("/var/www/codo")])])]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n        listen      80;\n        server_name demo-init.opendevops.cn;\n        access_log /var/log/nginx/codo-access.log;\n        error_log  /var/log/nginx/codo-error.log;\n\n        location / {\n                    root /var/www/codo;\n                    index index.html index.htm;\n                    try_files $uri $uri/ /index.html;\n                    expires 7d;\n                    }\n\n        location /api/ {\n                proxy_redirect off;\n                proxy_read_timeout 600;\n                proxy_http_version 1.1;\n                proxy_set_header Upgrade $http_upgrade;\n                proxy_set_header Connection \"upgrade\";\n\t\tproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n\t\tadd_header 'Access-Control-Allow-Origin' '*';\n                proxy_pass http://gw.opendevops.cn;\n        }\n        location ~ /(.svn|.git|admin|manage|.sh|.bash)$ {\n            return 403;\n        }\n    }\nserver {\n      listen 80 default;\n      server_name _;\n      return 403;\n}\n\n")])])]),a("p",[a("strong",[s._v("注册API网关")])]),s._v(" "),a("blockquote",[a("p",[s._v("请仔细阅读下面需要修改配置的地方"),a("code",[s._v("vim /usr/local/openresty/nginx/lua/configs.lua")]),s._v(" 这个配置基本上都要修改，请务必仔细")])]),s._v(" "),a("div",{staticClass:"language-lua extra-class"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cjson"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\nredis_config "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    host "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.10.10.12'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    port "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    auth_pwd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'you_redis_passwd'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    db "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    alive_time "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    channel "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gw'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 注意：这里的token_secret必须要和codo-admin里面的token_secret保持一致")]),s._v("\ntoken_secret "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pXFb4i%*834gfdh963df718iodGq4dsafsdadg7yI6ImF1999aaG7"')]),s._v("\nlogs_file "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/var/log/gw.log'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--刷新权限到redis接口")]),s._v("\nrewrite_cache_url "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://mg.opendevops.cn/v2/accounts/verify/'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 注意：rewrite_cache_token要和codo-admin里面的secret_key配置保持一致")]),s._v("\nrewrite_cache_token "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'8b888a62-3edb-4920-b446-697a472b4001'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--并发限流配置")]),s._v("\nlimit_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    rate "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--限制ip每分钟只能调用n*60次接口")]),s._v("\n    burst "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--桶容量,用于平滑处理,最大接收请求次数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--upstream匹配规则")]),s._v("\ngw_domain_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gw.opendevops.cn'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 不用再担心域名对应的接口了，建议内部的域名无需更改，只改简单的即可了，反正都是内部通信")]),s._v("\nrewrite_conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("gw_domain_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        rewrite_urls "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cmdb2"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cmdb2.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/tools"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tools.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/kerrigan"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kerrigan.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/task"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"task.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/cron"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cron.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/mg"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mg.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/accounts"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                rewrite_upstream "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mg.opendevops.cn"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[a("strong",[s._v("测试启动")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#access/error log path")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/log/nginx/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#测试")]),s._v("\n$ openresty -t\nnginx: the configuration "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /usr/local/openresty/nginx/conf/nginx.conf syntax is ok\nnginx: configuration "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" /usr/local/openresty/nginx/conf/nginx.conf "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" is successful\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动")]),s._v("\nsystemctl start openresty\nsystemctl status openresty\n\n")])])]),a("h2",{attrs:{id:"项目前端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目前端"}},[s._v("#")]),s._v(" 项目前端")]),s._v(" "),a("p",[a("strong",[s._v("生成最新的前端")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("which")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v("/dev/null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#下载前端代码、进到项目目录执行build")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" -d /opt/codo/codo "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /opt/codo/ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/opendevops-cn/codo.git  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" codo\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#build 最新的前端文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这里很多人慢的话都是因为网络不好，建议换成淘宝的源试试！")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" registry https://registry.npmjs.org/ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" cache clean --force "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --ignore-script "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run build\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#网站目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /var/www/codo\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("cp -rp dist/* /var/www/codo/\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#API文档(如果你需要)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/codo/codo\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("cp -r swagger-ui/ /var/www/codo/\n\n")])])]),a("p",[a("strong",[s._v("配置代理")])]),s._v(" "),a("ul",[a("li",[s._v("将静态文件代理出来，我这里使用API网关的openresty进行统一代理所有nginx域名")])]),s._v(" "),a("p",[a("code",[s._v("/usr/local/openresty/nginx/conf/conf.d/demo.conf")]),s._v(" 已配置")]),s._v(" "),a("h3",{attrs:{id:"访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问"}},[s._v("#")]),s._v(" 访问")]),s._v(" "),a("ul",[a("li",[s._v("地址：demo-init.opendevops.cn")]),s._v(" "),a("li",[s._v("用户：admin")]),s._v(" "),a("li",[s._v("密码：admin@opendevops")])]),s._v(" "),a("h3",{attrs:{id:"日志路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志路径"}},[s._v("#")]),s._v(" 日志路径")]),s._v(" "),a("ul",[a("li",[s._v("若这里访问有报错，请看下日志，一般都是配置错误。")]),s._v(" "),a("li",[s._v("日志路径：所有模块日志统一/var/log/supervisor/")]),s._v(" "),a("li",[s._v("也可以"),a("code",[s._v("pm2 logs -f xxxx")])])]),s._v(" "),a("h3",{attrs:{id:"健康检查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#健康检查"}},[s._v("#")]),s._v(" 健康检查")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进行所有服务进行检测，返回200则正常")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://mg.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://task.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://cmdb2.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://kerrigan.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://cron.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I -X GET -m "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" -o /dev/null -s -w %"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("http_code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" http://tools.opendevops.cn/are_you_ok/\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])])]),a("h3",{attrs:{id:"问题记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题记录"}},[s._v("#")]),s._v(" 问题记录")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('Q: openresty -t\nnginx: [emerg] host not found in upstream "gw.opendevops.cn" in /usr/local/openresty/nginx/conf/./conf.d/demo.conf:23\nnginx: configuration file /usr/local/openresty/nginx/conf/nginx.conf test failed\n\nA: 这里一般都是dns解析不到，如果你是用了内部自己的DNS 请确保都已经添加了解析\n如果你是按照文档部署的本地DNS，请确保你`cat /etc/resolv.conf`中的`nameserver xxxx`为你自己的IP\n\n\nQ: 部署完后直接IP访问403\nA：因为是用的nginx vhosts 需要进行解析域名的。\n- 临时测试方法：\n如果你是Windows，修改`C:\\Windows\\System32\\drivers\\etc\\hosts`Hosts记录访问测试\n如果你是Mac用户，直接sudo vim /etc/hosts  绑定解析即可\n')])])])])}),[],!1,null,null,null);t.default=e.exports}}]);